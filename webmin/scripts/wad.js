var audioContext=window.AudioContext||window.webkitAudioContext,context=new audioContext;getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.getUserMedia,getUserMedia?getUserMedia=getUserMedia.bind(navigator):console.log("get user media is not supported");var Wad=function(){function e(e,t){var n=4,a=1e3,o=1e3,i=-1,s=0,r=0,c=!1;if(e.length<o+a-n)return-1;for(var l=0;o>l;l++){var u=(e[l]-128)/128;r+=u*u}if(r=Math.sqrt(r/o),.01>r)return-1;for(var d=1,p=n;a>=p;p++){for(var h=0,l=0;o>l;l++)h+=Math.abs((e[l]-128)/128-(e[l+p]-128)/128);if(h=1-h/o,h>.9&&h>d)c=!0;else if(c)return t/i;d=h,h>s&&(s=h,i=p)}return s>.01?t/i:-1}var t=function(){Math.seed=6,Math.seededRandom=function(e,t){e=e||1,t=t||0,Math.seed=(9301*Math.seed+49297)%233280;var n=Math.seed/233280;return t+n*(e-t)};for(var e=2*context.sampleRate,t=context.createBuffer(1,e,context.sampleRate),n=t.getChannelData(0),a=0;e>a;a++)n[a]=2*Math.seededRandom()-1;return t}(),n=function(e){return"[object Array]"===Object.prototype.toString.call(e)},a=function(e,t){e.env={attack:t.env?t.env.attack||0:0,decay:t.env?t.env.decay||0:0,sustain:t.env?t.env.sustain||1:1,hold:t.env?t.env.hold||3.14:3.14,release:t.env?t.env.release||0:0},e.defaultEnv={attack:t.env?t.env.attack||0:0,decay:t.env?t.env.decay||0:0,sustain:t.env?t.env.sustain||1:1,hold:t.env?t.env.hold||3.14:3.14,release:t.env?t.env.release||0:0}},o=function(e,t){t.filter&&(n(t.filter)?t.filter.forEach(function(t){o(e,{filter:t})}):(t.filter=[t.filter],e.filter=t.filter))},i=function(e,t){var n=new XMLHttpRequest;n.open("GET",e.source,!0),n.responseType="arraybuffer",e.playable--,n.onload=function(){context.decodeAudioData(n.response,function(n){e.decodedBuffer=n,t&&t(e),e.playable++,e.playOnLoad&&e.play(e.playOnLoadArg)})},n.send()},s=function(e,t){t.vibrato&&(e.vibrato={shape:t.vibrato.shape||"sine",speed:t.vibrato.speed||1,magnitude:t.vibrato.magnitude||5,attack:t.vibrato.attack||0})},r=function(e,t){t.tremolo&&(e.tremolo={shape:t.tremolo.shape||"sine",speed:t.tremolo.speed||1,magnitude:t.tremolo.magnitude||5,attack:t.tremolo.attack||1})},c=function(e,t){if(t.reverb){e.reverb={wet:t.reverb.wet||1};var n=t.reverb.impulse||p.defaultImpulse,a=new XMLHttpRequest;a.open("GET",n,!0),a.responseType="arraybuffer",e.playable--,a.onload=function(){context.decodeAudioData(a.response,function(n){e.reverb.buffer=n,e.playable++,e.playOnLoad&&e.play(e.playOnLoadArg),e instanceof p.Poly&&e.setUp(t)})},a.send()}},l=function(e,t){"panning"in t?"number"==typeof t.panning?e.panning={location:[t.panning,0,0]}:e.panning={location:[t.panning[0],t.panning[1],t.panning[2]]}:e.panning={location:[0,0,0]}},u=function(e,t){t.delay&&(e.delay={delayTime:t.delay.delayTime||.5,maxDelayTime:t.delay.maxDelayTime||2,feedback:t.delay.feedback||.25,wet:t.delay.wet||.25})},d=function(e,t){getUserMedia({audio:!0,video:!1},function(n){e.nodes=[],e.mediaStreamSource=context.createMediaStreamSource(n),e.gain=context.createGain(),e.gain.gain.value=e.volume,e.nodes.push(e.mediaStreamSource),e.nodes.push(e.gain),e.filter&&m(e,t),e.reverb&&(e.reverb.node=context.createConvolver(),e.reverb.node.buffer=e.reverb.buffer,e.reverb.gain=context.createGain(),e.reverb.gain.gain.value=e.reverb.wet,e.nodes.push(e.reverb.node),e.nodes.push(e.reverb.gain)),e.panning&&(e.panning.node=context.createPanner(),e.panning.node.setPosition(e.panning.location[0],e.panning.location[1],e.panning.location[2]),e.nodes.push(e.panning.node)),e.delay&&T(e,t)},function(e){console.log("Error setting up microphone input: ",e)})},p=function(e){if(this.source=e.source,this.destination=e.destination||context.destination,this.volume=e.volume||1,this.defaultVolume=this.volume,this.playable=1,this.pitch=p.pitches[e.pitch]||e.pitch||440,this.detune=e.detune||0,this.globalReverb=e.globalReverb||!1,this.gain=[],this.loop=e.loop||!1,a(this,e),o(this,e),s(this,e),r(this,e),c(this,e),this.constructExternalFx(e,context),l(this,e),u(this,e),"noise"===this.source)this.decodedBuffer=t;else if("mic"===this.source)d(this,e);else if("object"==typeof this.source){var n=context.createBuffer(2,this.source[0].length,context.sampleRate);n.getChannelData(0).set(this.source[0]),n.getChannelData(1).set(this.source[1]),this.decodedBuffer=n}else this.source in{sine:0,sawtooth:0,square:0,triangle:0}?e.callback&&e.callback(this):i(this,e.callback)},h=function(e,t){e.filter.forEach(function(e,n){e.node.frequency.linearRampToValueAtTime(e.frequency,t.exactTime),e.node.frequency.linearRampToValueAtTime(e.env.frequency,t.exactTime+e.env.attack)})},v=function(e,t){e.gain[0].gain.linearRampToValueAtTime(1e-4,t.exactTime),e.gain[0].gain.linearRampToValueAtTime(e.volume,t.exactTime+e.env.attack+1e-5),e.gain[0].gain.linearRampToValueAtTime(e.volume*e.env.sustain,t.exactTime+e.env.attack+e.env.decay+2e-5),e.gain[0].gain.linearRampToValueAtTime(e.volume*e.env.sustain,t.exactTime+e.env.attack+e.env.decay+e.env.hold+3e-5),e.gain[0].gain.linearRampToValueAtTime(1e-4,t.exactTime+e.env.attack+e.env.decay+e.env.hold+e.env.release+4e-5),e.soundSource.start(t.exactTime),e.soundSource.stop(t.exactTime+e.env.attack+e.env.decay+e.env.hold+e.env.release)},f=function(e,t){for(var n=t&&t.destination||e.destination,a=1;a<e.nodes.length;a++)e.nodes[a-1].connect(e.nodes[a]),e.nodes[a]instanceof ConvolverNode&&e.nodes[a-1].connect(e.nodes[a+2]);e.nodes[e.nodes.length-1].connect(n),p.reverb&&e.globalReverb&&(e.nodes[e.nodes.length-1].connect(p.reverb.node),p.reverb.node.connect(p.reverb.gain),p.reverb.gain.connect(n))},y=function(e,t){t=t||{},e.soundSource=context.createOscillator(),e.soundSource.type=e.source,t.pitch?t.pitch in p.pitches?e.soundSource.frequency.value=p.pitches[t.pitch]:e.soundSource.frequency.value=t.pitch:e.soundSource.frequency.value=e.pitch,e.soundSource.detune.value=t.detune||e.detune},g=function(e,t){t&&t.env?(e.env.attack=t.env.attack||e.defaultEnv.attack,e.env.decay=t.env.decay||e.defaultEnv.decay,e.env.sustain=t.env.sustain||e.defaultEnv.sustain,e.env.hold=t.env.hold||e.defaultEnv.hold,e.env.release=t.env.release||e.defaultEnv.release):e.env={attack:e.defaultEnv.attack,decay:e.defaultEnv.decay,sustain:e.defaultEnv.sustain,hold:e.defaultEnv.hold,release:e.defaultEnv.release}},m=function(e,t){e.filter.forEach(function(n,a){n.node=context.createBiquadFilter(),n.node.type=n.type,n.node.frequency.value=t.filter[a]?t.filter[a].frequency||n.frequency:n.frequency,n.node.Q.value=t.filter[a]?t.filter[a].q||n.q:n.q,(t.filter[a].env||e.filter[a].env)&&"mic"!==e.source&&(n.env={attack:t.filter[a].env&&t.filter[a].env.attack||e.filter[a].env.attack,frequency:t.filter[a].env&&t.filter[a].env.frequency||e.filter[a].env.frequency}),e.nodes.push(n.node)})},b=function(e,t){t&&t.filter&&e.filter?(n(t.filter)||(t.filter=[t.filter]),m(e,t)):e.filter&&m(e,e)},x=function(e,t){e.reverb.node=context.createConvolver(),e.reverb.node.buffer=e.reverb.buffer,e.reverb.gain=context.createGain(),e.reverb.gain.gain.value=e.reverb.wet,e.nodes.push(e.reverb.node),e.nodes.push(e.reverb.gain)},A=function(e,t){if(t&&t.panning||e.panning){if(e.panning.node=context.createPanner(),t&&t.panning)if(console.log("arg!",t.panning),"number"==typeof t.panning)var n=[t.panning,0,0];else var n=[t.panning[0],t.panning[1],t.panning[2]];else if(e.panning)var n=e.panning.location;else var n=[0,0,0];e.panning.node.setPosition(n[0],n[1],n[2]),e.nodes.push(e.panning.node)}},k=function(e,t){e.vibrato.wad=new p({source:e.vibrato.shape,pitch:e.vibrato.speed,volume:e.vibrato.magnitude,env:{attack:e.vibrato.attack},destination:e.soundSource.frequency}),e.vibrato.wad.play()},w=function(e,t){e.tremolo.wad=new p({source:e.tremolo.shape,pitch:e.tremolo.speed,volume:e.tremolo.magnitude,env:{attack:e.tremolo.attack,hold:10},destination:e.gain[0].gain}),e.tremolo.wad.play()},T=function(e,t){e.delay&&(t.delay||(t.delay={}),e.delay.input=context.createGain(),e.delay.output=context.createGain(),e.delay.delayNode=context.createDelay(maxDelayTime=e.delay.maxDelayTime),e.delay.feedbackNode=context.createGain(),e.delay.wetNode=context.createGain(),e.delay.delayNode.delayTime.value=t.delay.delayTime||e.delay.delayTime,e.delay.feedbackNode.gain.value=t.delay.feedback||e.delay.feedback,e.delay.wetNode.gain.value=t.delay.wet||e.delay.wet,e.delay.input.connect(e.delay.delayNode),e.delay.delayNode.connect(e.delay.feedbackNode),e.delay.delayNode.connect(e.delay.wetNode),e.delay.feedbackNode.connect(e.delay.delayNode),e.delay.wetNode.connect(e.delay.output),e.nodes.push(e.delay.input),e.nodes.push(e.delay.output))},D=function(e,t){e.compressor=context.createDynamicsCompressor(),e.compressor.attack.value=t.compressor.attack||e.compressor.attack.value,e.compressor.knee.value=t.compressor.knee||e.compressor.knee.value,e.compressor.ratio.value=t.compressor.ratio||e.compressor.ratio.value,e.compressor.release.value=t.compressor.release||e.compressor.release.value,e.compressor.threshold.value=t.compressor.threshold||e.compressor.threshold.value,e.nodes.push(e.compressor)};p.prototype.constructExternalFx=function(e,t){},p.prototype.setUpExternalFxOnPlay=function(e,t){},p.prototype.play=function(e){return e=e||{},this.playable<1?(this.playOnLoad=!0,this.playOnLoadArg=e):"mic"===this.source?f(this,e):(this.nodes=[],e.wait||(e.wait=0),e.volume?this.volume=e.volume:this.volume=this.defaultVolume,this.source in{sine:0,sawtooth:0,square:0,triangle:0}?y(this,e):(this.soundSource=context.createBufferSource(),this.soundSource.buffer=this.decodedBuffer,("noise"===this.source||this.loop||e.loop)&&(this.soundSource.loop=!0)),void 0===e.exactTime&&(e.exactTime=context.currentTime+e.wait),this.nodes.push(this.soundSource),g(this,e),b(this,e),this.setUpExternalFxOnPlay(e,context),this.gain.unshift(context.createGain()),this.gain[0].label=e.label,this.nodes.push(this.gain[0]),this.reverb&&x(this,e),A(this,e),T(this,e),f(this,e),this.filter&&this.filter[0].env&&h(this,e),v(this,e),this.vibrato&&k(this,e),this.tremolo&&w(this,e)),e.callback&&e.callback(this),this},p.prototype.setVolume=function(e){return this.defaultVolume=e,this.gain.length>0&&(this.gain[0].gain.value=e),this},p.prototype.setDetune=function(e){return this.soundSource.detune.value=e,this},p.prototype.setPanning=function(e){return"number"==typeof e?this.panning.node.setPosition(e,this.panning.location[1],this.panning.location[2]):this.panning.node.setPosition(e[0],e[1],e[2]),this},p.prototype.stop=function(e){if("mic"!==this.source){if(e)for(var t=0;t<this.gain.length;t++)this.gain[t].label===e&&(this.gain[t].gain.cancelScheduledValues(context.currentTime),this.gain[t].gain.setValueAtTime(this.gain[t].gain.value,context.currentTime),this.gain[t].gain.linearRampToValueAtTime(1e-4,context.currentTime+this.env.release));e||(this.gain[0].gain.cancelScheduledValues(context.currentTime),this.gain[0].gain.setValueAtTime(this.gain[0].gain.value,context.currentTime),this.gain[0].gain.linearRampToValueAtTime(1e-4,context.currentTime+this.env.release))}else this.mediaStreamSource.disconnect(0)};var G=2048,C=new Uint8Array(G),E=function(e){var t=12*(Math.log(e/440)/Math.log(2));return Math.round(t)+69};p.Poly=function(e){e||(e={}),this.isSetUp=!1,this.playable=1,e.reverb?c(this,e):this.setUp(e)},p.Poly.prototype.setUp=function(e){if(this.wads=[],this.input=context.createAnalyser(),this.input.fftSize=2048,this.nodes=[this.input],this.destination=e.destination||context.destination,this.volume=e.volume||1,this.output=context.createGain(),this.output.gain.value=this.volume,"undefined"!=typeof Recorder&&e.recConfig){this.rec=new Recorder(this.output,e.recConfig),this.rec.recordings=[];var t=this,n=function(e){t.rec.createWadArg.source=e,t.rec.recordings.unshift(new p(t.rec.createWadArg))};this.rec.createWad=function(e){this.createWadArg=e||{env:{hold:9001}},this.getBuffer(n)}}this.globalReverb=e.globalReverb||!1,o(this,e),this.filter&&m(this,e),this.reverb&&x(this,e),this.constructExternalFx(e,context),l(this,e),A(this,e),e.compressor&&D(this,e),u(this,e),T(this,e),this.nodes.push(this.output),f(this,e),this.isSetUp=!0,e.callback&&e.callback(this)},p.Poly.prototype.updatePitch=function(t){this.input.getByteTimeDomainData(C);var n=e(C,context.sampleRate);if(-1!==n&&11025!==n&&12e3!==n){var a=n;this.pitch=Math.floor(a);var o=E(a);this.noteName=p.pitchesArray[o-12]}var i=this;i.rafID=window.requestAnimationFrame(function(){i.updatePitch()})},p.Poly.prototype.stopUpdatingPitch=function(){cancelAnimationFrame(this.rafID)},p.Poly.prototype.setVolume=function(e){return this.isSetUp?this.output.gain.value=e:console.log("This PolyWad is not set up yet."),this},p.Poly.prototype.play=function(e){if(this.isSetUp)if(this.playable<1)this.playOnLoad=!0,this.playOnLoadArg=e;else{e&&e.volume&&(this.output.gain.value=e.volume,e.volume=void 0);for(var t=0;t<this.wads.length;t++)this.wads[t].play(e)}else console.log("This PolyWad is not set up yet.");return this},p.Poly.prototype.stop=function(e){if(this.isSetUp)for(var t=0;t<this.wads.length;t++)this.wads[t].stop(e)},p.Poly.prototype.add=function(e){return this.isSetUp?(e.destination=this.input,this.wads.push(e),e instanceof p.Poly&&(e.output.disconnect(0),e.output.connect(this.input))):console.log("This PolyWad is not set up yet."),this},p.Poly.prototype.remove=function(e){if(this.isSetUp)for(var t=0;t<this.wads.length;t++)this.wads[t]===e&&(this.wads[t].destination=context.destination,this.wads.splice(t,1),e instanceof p.Poly&&(e.output.disconnect(0),e.output.connect(context.destination)));return this},p.Poly.prototype.constructExternalFx=function(e,t){},p.defaultImpulse="http://www.codecur.io/us/sendaudio/widehall.wav",p.setGlobalReverb=function(e){p.reverb={},p.reverb.node=context.createConvolver(),p.reverb.gain=context.createGain(),p.reverb.gain.gain.value=e.wet;var t=e.impulse||p.defaultImpulse,n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){context.decodeAudioData(n.response,function(e){p.reverb.node.buffer=e})},n.send()},p.pitches={A0:27.5,"A#0":29.1352,Bb0:29.1352,B0:30.8677,C1:32.7032,"C#1":34.6478,Db1:34.6478,D1:36.7081,"D#1":38.8909,Eb1:38.8909,E1:41.2034,F1:43.6535,"F#1":46.2493,Gb1:46.2493,G1:48.9994,"G#1":51.9131,Ab1:51.9131,A1:55,"A#1":58.2705,Bb1:58.2705,B1:61.7354,C2:65.4064,"C#2":69.2957,Db2:69.2957,D2:73.4162,"D#2":77.7817,Eb2:77.7817,E2:82.4069,F2:87.3071,"F#2":92.4986,Gb2:92.4986,G2:97.9989,"G#2":103.826,Ab2:103.826,A2:110,"A#2":116.541,Bb2:116.541,B2:123.471,C3:130.813,"C#3":138.591,Db3:138.591,D3:146.832,"D#3":155.563,Eb3:155.563,E3:164.814,F3:174.614,"F#3":184.997,Gb3:184.997,G3:195.998,"G#3":207.652,Ab3:207.652,A3:220,"A#3":233.082,Bb3:233.082,B3:246.942,C4:261.626,"C#4":277.183,Db4:277.183,D4:293.665,"D#4":311.127,Eb4:311.127,E4:329.628,F4:349.228,"F#4":369.994,Gb4:369.994,G4:391.995,"G#4":415.305,Ab4:415.305,A4:440,"A#4":466.164,Bb4:466.164,B4:493.883,C5:523.251,"C#5":554.365,Db5:554.365,D5:587.33,"D#5":622.254,Eb5:622.254,E5:659.255,F5:698.456,"F#5":739.989,Gb5:739.989,G5:783.991,"G#5":830.609,Ab5:830.609,A5:880,"A#5":932.328,Bb5:932.328,B5:987.767,C6:1046.5,"C#6":1108.73,Db6:1108.73,D6:1174.66,"D#6":1244.51,Eb6:1244.51,E6:1318.51,F6:1396.91,"F#6":1479.98,Gb6:1479.98,G6:1567.98,"G#6":1661.22,Ab6:1661.22,A6:1760,"A#6":1864.66,Bb6:1864.66,B6:1975.53,C7:2093,"C#7":2217.46,Db7:2217.46,D7:2349.32,"D#7":2489.02,Eb7:2489.02,E7:2637.02,F7:2793.83,"F#7":2959.96,Gb7:2959.96,G7:3135.96,"G#7":3322.44,Ab7:3322.44,A7:3520,"A#7":3729.31,Bb7:3729.31,B7:3951.07,C8:4186.01},p.pitchesArray=["C0","C#0","D0","D#0","E0","F0","F#0","G0","G#0","A0","A#0","B0","C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5","C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6","C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7","C8"],p.midiInstrument={play:function(){console.log("playing midi")},stop:function(){console.log("stopping midi")}},p.midiInputs=[],midiMap=function(e){console.log(e.receivedTime,e.data),144===e.data[0]?0===e.data[2]?(console.log("|| stopping note: ",p.pitchesArray[e.data[1]-12]),p.midiInstrument.stop(p.pitchesArray[e.data[1]-12])):e.data[2]>0&&(console.log("> playing note: ",p.pitchesArray[e.data[1]-12]),p.midiInstrument.play({pitch:p.pitchesArray[e.data[1]-12],label:p.pitchesArray[e.data[1]-12],callback:function(e){}})):176===e.data[0]?(console.log("controller"),46==e.data[1]&&(127==e.data[2]?p.midiInstrument.pedalMod=!0:0==e.data[2]&&(p.midiInstrument.pedalMod=!1))):224===e.data[0]&&console.log("pitch bend")};var q=null,F=function(e){q=e,p.midiInputs=q.inputs(),console.log(p.midiInputs);for(var t=0;t<p.midiInputs.length;t++)p.midiInputs[t].onmidimessage=midiMap},S=function(e){console.log("uh-oh! Something went wrong!  Error code: "+e.code)};if(navigator&&navigator.requestMIDIAccess)try{navigator.requestMIDIAccess().then(F,S)}catch(B){var M="There was an error on this page.\n\n";M+="Error description: "+B.message+"\n\n",M+="Click OK to continue.\n\n",console.log(M)}return p.presets={hiHatClosed:{source:"noise",env:{attack:.001,decay:.008,sustain:.2,hold:.03,release:.01},filter:{type:"highpass",frequency:400,q:1}},snare:{source:"noise",env:{attack:.001,decay:.01,sustain:.2,hold:.03,release:.02},filter:{type:"bandpass",frequency:300,q:.18}},hiHatOpen:{source:"noise",env:{attack:.001,decay:.008,sustain:.2,hold:.43,release:.01},filter:{type:"highpass",frequency:100,q:.2}},ghost:{source:"square",volume:.3,env:{attack:.01,decay:.002,sustain:.5,hold:2.5,release:.3},filter:{type:"lowpass",frequency:600,q:7,env:{attack:.7,frequency:1600}},vibrato:{attack:8,speed:8,magnitude:100}},piano:{source:"square",volume:1.4,env:{attack:.01,decay:.005,sustain:.2,hold:.015,release:.3},filter:{type:"lowpass",frequency:1200,q:8.5,env:{attack:.2,frequency:600}}}},p}();"undefined"!=typeof module&&module.exports&&(module.exports=Wad);
